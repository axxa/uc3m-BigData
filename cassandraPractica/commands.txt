cd D:\mongo3.4.23\bin\
mongoexport --db practicaMongo --collection cPractica /type csv /fields:"_id,billing,TOTAL,Client.DNI,Client.Name,Client.Surname" /out:"mydump.txt"
mongoexport --db practicaMongo --collection cPractica /type csv /fields:"_id,billing,TOTAL,Client.DNI,Client.Name,Client.Surname,contract.country,Movies.Date,Movies.Viewing PCT" /out:"mydump.txt"


Coleccion de preparacion para cassandra:

1) Consumos por origen: se almacenarán consumos (individuales). Los informes se
harán mensuales (por cada mes) para cada país y para cada país y director. Debe
tenerse en cuenta que estos informes pueden venir limitados por un rango de
porcentaje de visualización ('viewing pct'). 

En mongo:

	db.cPractica.aggregate([
		{$project:{_id:0}},
		{$unwind:"$Movies"},
		{$project:{"contract.country":1,
		"viewDate": {$concat: [{ $substr: ["$Movies.Date", 6, 4] },"-",{ $substr: ["$Movies.Date", 3, 2] },"-",{ $substr: ["$Movies.Date",0,2] }]},
		"Movies.Viewing PCT":1,"Movies.Details.Director.Name":1 }}, 
		{$out:"cassandraPrep1"} 
	]);
	
En shell:
	
	Exportacion de datos en mongo:
		mongoexport --db practicaMongo --collection cassandraPrep1 /type csv /fields:"_id,contract.country,viewDate,Movies.Viewing PCT,Movies.Details.Director.Name" /out:"cassandraPrep1CSV.txt"

Diseño cassandra:

	En cassandra:

	CREATE KEYSPACE myKeyspace WITH replication = {'class': 'SimpleStrategy','replication_factor' : 2};
	use myKeyspace;

	create table consumosPorOrigen(
		id text,
		contractCountry text,
		viewDate timestamp,
		viewingPCT smallint,
		directorName text,
		PRIMARY KEY (id)
	);

Nota: Tuve que cambiar el tipo de la columna de viewDate de timestamp a text debido al siguiente error

Failed to import 158 rows: ParseError - Failed to parse 08/01/2016 : time data '08/01/2016' does not match format '%Y-%m-%d',  given up without retries

Y esto se debe a que no hay comtrol sobre los formatos de fecha en la instruccion COPY y por tanto se tendria que parchear para agregar la opcion.
referencia: https://issues.apache.org/jira/browse/CASSANDRA-8970

Importacion de datos a cassandra:

COPY consumosPorOrigen (id,contractCountry,viewDate,viewingPCT,directorName) FROM 'D:\mongo3.4.23\bin\cassandraPrep1CSV.txt' WITH HEADER = 'true';


Descripcion: En mongo se obtiene el pais del contrato y se hace un unwind de Movies para obtener la fecha y porcentaje de visualizacion, asi como el nombre del director
	
2) Resumen facturación: para cada cliente (DNI, full name) se almacenarán sus
facturas mensuales, con los totales de #taps, tráfico (minutos), y monto de la
factura. La consulta principal para esta tabla es el informe anual (totales por año y
cliente). 

En mongo:
	db.cPractica.aggregate([
		{$project:{_id:0}},
		{$unwind:"$Movies"},
		{$project:{"TOTAL":1,"charge date": 1,"Client.DNI":1,"Client.Name":1,"Client.Surname":1,
				   "traficoMinutos": { $sum : {$multiply: ["$Movies.Details.Duration" ,{$divide:["$Movies.Viewing PCT",100]}]} }  }}, 
		{$out:"cassandraPrep2"} 
	]);

En shell:
	
mongoexport --db practicaMongo --collection cassandraPrep2 /type csv /fields:"_id,TOTAL,charge date,Client.DNI,Client.Name,Client.Surname,traficoMinutos" /out:"cassandraPrep2CSV.txt"

Descripcion:

Diseño tabla:

create table resumenFacturacion(
	id text,
	valorFactura double,
	chargeDate timestamp,
	clientDNI text,
	clientName text,
	clientSurname text,
	traficoMinutos int,
	PRIMARY KEY (id)
);